//asw.c

#include "bsw.h"

TASK(Task1){
   printfSerial("Task1 Begins...\n");
   mdelay(5000);
   printfSerial("Task1 Finishes...\n");
}

TASK(Task2){
   EventMaskType mask;
   printfSerial("Task2 Begins...\n");
   printfSerial("Task2 Waits...\n");
   WaitEvent(Event1 | Event2);
   printfSerial("Task2 Wakes Up...\n");
   GetEvent(Task2, &mask);
   if(mask & Event1){
      printfSerial("[Event1]\n");
      ClearEvent(Event1);
   }
   if(mask & Event2){
      printfSerial("[Event2]\n");
      ClearEvent(Event2);
   }
   printfSerial("Task2 Finishes...\n");
   TerminateTask();
}

ISR2(TimerISR)
{
   static long c = -4;
   IncrementCounter(counter1);
   printfSerial("\n%4ld: ",c++);
}

ALARMCALLBACK(MyCallback1)
{
      DisableAllInterrupts();
      IncrementCounter(counter1);
      SetEvent(Task2,Event1);
}
ALARMCALLBACK(MyCallback2)
{
      DisableAllInterrupts();
      IncrementCounter(counter1);
      SetEvent(Task2,Event2);
}


//conf.oil

CPU mySystem {
    OS myOs {
      EE_OPT = "OS_EE_APPL_BUILD_DEBUG";
      EE_OPT = "OS_EE_BUILD_DEBUG";

        USERESSCHEDULER = TRUE;
        CPU_DATA = AVR8 {
            MULTI_STACK = TRUE;
        };
        MCU_DATA = MEGA {
            MODEL = MEGA_328p;
        };
        LIB = ARDUINO {
            SDK_BOARD = UNO;
            VARIANT = CC {
                VERSION = "1.8.5";
            };
            STAND_ALONE = TRUE;        // Generate arduino libraries
        };
        KERNEL_TYPE = OSEK {
            CLASS = ECC2;    // Default
        };
    };
    EVENT Event1 {MASK = AUTO;};
    EVENT Event2 {MASK = AUTO;};
    
    APPDATA myApp {
        APP_SRC = "bsw.cpp";
        APP_SRC = "asw.c";
    };
    
    TASK Task1{
       PRIORITY = 1;
       STACK = SHARED;
       SCHEDULE = FULL;
       AUTOSTART = FALSE;
       ACTIVATION = 1;
    };
    
    TASK Task2{
        PRIORITY = 2;
       STACK = PRIVATE{
          SIZE = 512;
       };
       SCHEDULE = FULL;
       EVENT = Event1;
       EVENT = Event2;
       AUTOSTART = FALSE;
       ACTIVATION = 1;
    };

       ISR TimerISR{
       CATEGORY = 2;
       SOURCE = "TIMER1_COMPA";
    };
    COUNTER counter1{
       MINCYCLE = 1;
       MAXALLOWEDVALUE = 127;
       TICKSPERBASE = 1;
    };
    ALARM alarm1{
       COUNTER = counter1;
       ACTION = ACTIVATETASK{
          TASK = Task1;
       };
       AUTOSTART = TRUE{
          ALARMTIME = 5;
          CYCLETIME = 10;
       };
    };
    ALARM alarm2{
       COUNTER = counter1;
       ACTION = ACTIVATETASK{
          TASK = Task2;
       };
       AUTOSTART = TRUE{
          ALARMTIME = 5;
          CYCLETIME = 20;
       };
    };
        ALARM alarm3{
       COUNTER = counter1;
       ACTION = ALARMCALLBACK{
          ALARMCALLBACKNAME = "MyCallback1";
          
       };
       AUTOSTART = TRUE{
          ALARMTIME = 15;
          CYCLETIME = 40;
       };
    };
     ALARM alarm4{
       COUNTER = counter1;
       ACTION = ALARMCALLBACK{
          ALARMCALLBACKNAME = "MyCallback2";
          
       };
       AUTOSTART = TRUE{
          ALARMTIME = 35;
          CYCLETIME = 40;
       };
    };
};

//bsw.h

#ifndef BSW_H_
#define BSW_H_

#include "ee.h"
#include "Arduino.h"

#ifdef __cplusplus
extern "C"{
#endif

void mdelay(unsigned long delay_ms);

void printfSerial(const char *fmt, ... );

#ifdef __cplusplus
}
#endif
#endif /* BSW_H_ */
